<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.teacher.course.TeachingClassMapper">

  <resultMap id="TeachingClassMap" type="org.example.chaoxingsystem.teacher.course.TeachingClass">
    <id property="id" column="id"/>
    <result property="courseId" column="course_id"/>
    <result property="name" column="name"/>
    <result property="assignedTeacherId" column="assigned_teacher_id"/>
    <result property="createTime" column="create_time"/>
  </resultMap>

  <select id="selectByCourse" resultType="map">
    SELECT 
      c.id, 
      c.name, 
      c.assigned_teacher_id,
      u.real_name AS assignedTeacherName,
      c.create_time,
      (SELECT COUNT(1) FROM biz_teaching_class_student s WHERE s.class_id = c.id) AS studentCount
    FROM biz_teaching_class c
    LEFT JOIN users u ON u.id = c.assigned_teacher_id
    WHERE c.subject_id = #{courseId}
    ORDER BY c.create_time DESC, c.id DESC
  </select>

  <select id="selectById" resultMap="TeachingClassMap">
    SELECT * FROM biz_teaching_class WHERE id = #{id}
  </select>

  <insert id="insert" parameterType="org.example.chaoxingsystem.teacher.course.TeachingClass" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO biz_teaching_class (subject_id, name, assigned_teacher_id)
    VALUES (#{courseId}, #{name}, #{assignedTeacherId})
  </insert>

  <update id="updateById" parameterType="org.example.chaoxingsystem.teacher.course.TeachingClass">
    UPDATE biz_teaching_class
    SET name = #{name},
        assigned_teacher_id = #{assignedTeacherId}
    WHERE id = #{id}
  </update>

  <delete id="deleteById">
    DELETE FROM biz_teaching_class WHERE id = #{id}
  </delete>

  <delete id="deleteByCourseId">
    DELETE FROM biz_teaching_class WHERE subject_id = #{courseId}
  </delete>

  <select id="selectClassStudents" resultType="map">
    SELECT 
      u.id AS id, 
      u.real_name AS name,
      s.student_no AS studentNo,
      bc.class_name AS adminClassName
    FROM biz_teaching_class_student tcs
    JOIN users u ON u.id = tcs.user_id
    LEFT JOIN biz_student s ON s.user_id = u.id
    LEFT JOIN biz_class bc ON bc.id = s.class_id
    WHERE tcs.class_id = #{classId}
    ORDER BY u.real_name ASC, u.id ASC
  </select>

  <insert id="insertClassStudent">
    INSERT IGNORE INTO biz_teaching_class_student (class_id, user_id)
    VALUES (#{classId}, #{userId})
  </insert>

  <delete id="deleteClassStudent">
    DELETE FROM biz_teaching_class_student
    WHERE class_id = #{classId} AND user_id = #{userId}
  </delete>
</mapper>
