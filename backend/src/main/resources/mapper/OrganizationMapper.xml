<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.admin.org.OrganizationMapper">

  <resultMap id="OrgMap" type="org.example.chaoxingsystem.admin.org.Organization">
    <id property="id" column="id"/>
    <result property="parentId" column="parent_id"/>
    <result property="name" column="name"/>
    <result property="code" column="code"/>
    <result property="type" column="type"/>
    <result property="sortOrder" column="sort_order"/>
    <result property="path" column="path"/>
    <result property="status" column="status"/>
    <result property="leader" column="leader"/>
    <result property="phone" column="phone"/>
    <result property="description" column="description"/>
  </resultMap>

  <insert id="insert" parameterType="org.example.chaoxingsystem.admin.org.Organization" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO sys_organization (parent_id, name, code, type, sort_order, path, status, leader, phone, description)
    VALUES (#{parentId}, #{name}, #{code}, #{type}, #{sortOrder}, #{path}, #{status}, #{leader}, #{phone}, #{description})
  </insert>

  <update id="updateById" parameterType="org.example.chaoxingsystem.admin.org.Organization">
    UPDATE sys_organization SET
      parent_id = #{parentId},
      name = #{name},
      code = #{code},
      type = #{type},
      sort_order = #{sortOrder},
      path = #{path},
      status = #{status},
      leader = #{leader},
      phone = #{phone},
      description = #{description}
    WHERE id = #{id}
  </update>

  <delete id="deleteById">
    DELETE FROM sys_organization WHERE id = #{id}
  </delete>

  <select id="selectById" resultMap="OrgMap">
    SELECT * FROM sys_organization WHERE id = #{id}
  </select>

  <select id="countChildren" resultType="long">
    SELECT COUNT(1) FROM sys_organization WHERE parent_id = #{id}
  </select>

  <select id="selectChildren" resultMap="OrgMap">
    SELECT * FROM sys_organization WHERE parent_id = #{parentId} ORDER BY sort_order ASC, id ASC
  </select>

  <select id="countByCode" resultType="long">
    SELECT COUNT(1) FROM sys_organization WHERE code = #{code}
  </select>

  <select id="selectAll" resultMap="OrgMap">
    SELECT * FROM sys_organization ORDER BY path ASC, sort_order ASC
  </select>

  <select id="selectSubtree" resultMap="OrgMap">
    SELECT * FROM sys_organization WHERE path LIKE CONCAT(#{pathPrefix}, '%') ORDER BY path ASC
  </select>

  <select id="listStudentMembersByClassIds" resultType="map">
    SELECT u.id AS userId,
           u.username AS username,
           s.real_name AS realName,
           u.user_type AS userType,
           s.student_no AS studentNo,
           s.class_id AS originOrgId
    FROM biz_student s
    JOIN users u ON u.id = s.user_id
    WHERE s.class_id IN
    <foreach collection="classIds" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
    ORDER BY s.student_no ASC
  </select>

  <select id="listTeacherMembersByCollegeIds" resultType="map">
    SELECT u.id AS userId,
           u.username AS username,
           u.real_name AS realName,
           u.user_type AS userType,
           t.employee_no AS teacherNo,
           t.college_id AS originOrgId
    FROM biz_teacher t
    JOIN users u ON u.id = t.user_id
    WHERE t.college_id IN
    <foreach collection="collegeIds" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
    ORDER BY t.employee_no ASC
  </select>

  <select id="listTeacherMembersByClassIds" resultType="map">
    SELECT u.id AS userId,
           u.username AS username,
           u.real_name AS realName,
           u.user_type AS userType,
           t.employee_no AS teacherNo
    FROM biz_class_teacher ct
    JOIN biz_teacher t ON t.id = ct.teacher_id
    JOIN users u ON u.id = t.user_id
    WHERE ct.class_id IN
    <foreach collection="classIds" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
    ORDER BY t.employee_no ASC
  </select>


</mapper>
