<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.teacher.exam.ExamMapper">

  <resultMap id="ExamMap" type="org.example.chaoxingsystem.teacher.exam.Exam">
    <id property="id" column="id"/>
    <result property="name" column="name"/>
    <result property="paperId" column="paper_id"/>
    <result property="startTime" column="start_time"/>
    <result property="endTime" column="end_time"/>
    <result property="duration" column="duration"/>
    <result property="status" column="status"/>
    <result property="creatorId" column="creator_id"/>
    <result property="createTime" column="create_time"/>
  </resultMap>

  <select id="count" resultType="long">
    SELECT COUNT(*) FROM biz_exam
    <where>
      <if test="status != null">
        AND status = #{status}
      </if>
    </where>
  </select>

  <select id="selectPage" resultMap="ExamMap">
    SELECT * FROM biz_exam
    <where>
      <if test="status != null">
        AND status = #{status}
      </if>
    </where>
    ORDER BY create_time DESC
    LIMIT #{offset}, #{limit}
  </select>

  <select id="selectById" resultMap="ExamMap">
    SELECT * FROM biz_exam WHERE id = #{id}
  </select>

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO biz_exam (name, paper_id, start_time, end_time, duration, status, creator_id)
    VALUES (#{name}, #{paperId}, #{startTime}, #{endTime}, #{duration}, #{status}, #{creatorId})
  </insert>

  <update id="updateById">
    UPDATE biz_exam
    SET name = #{name}, paper_id = #{paperId}, start_time = #{startTime},
        end_time = #{endTime}, duration = #{duration}, status = #{status}
    WHERE id = #{id}
  </update>

  <delete id="deleteById">
    DELETE FROM biz_exam WHERE id = #{id}
  </delete>

  <!-- 考试统计相关 -->
  <select id="countExamStudents" resultType="long">
    SELECT COUNT(DISTINCT er.student_id)
    FROM biz_exam_record er
    WHERE er.exam_id = #{examId}
  </select>

  <select id="countSubmittedStudents" resultType="long">
    SELECT COUNT(DISTINCT er.student_id)
    FROM biz_exam_record er
    WHERE er.exam_id = #{examId}
    AND er.status >= 1
  </select>

  <select id="countGradedStudents" resultType="long">
    SELECT COUNT(DISTINCT er.student_id)
    FROM biz_exam_record er
    WHERE er.exam_id = #{examId}
    AND er.status >= 2
    AND er.score IS NOT NULL
  </select>

  <!-- 监考相关 -->
  <select id="selectMonitorStudents" resultType="map">
    SELECT 
      er.student_id as studentId,
      u.username,
      u.real_name as realName,
      er.start_time as startTime,
      er.submit_time as submitTime,
      er.status,
      CASE 
        WHEN er.status = 0 THEN 'not_started'
        WHEN er.status = 1 AND er.submit_time IS NULL THEN 'online'
        WHEN er.submit_time IS NOT NULL THEN 'submitted'
        ELSE 'unknown'
      END as status_text,
      0 as switchCount,
      0 as warningCount
    FROM biz_exam_record er
    LEFT JOIN users u ON er.student_id = u.id
    WHERE er.exam_id = #{examId}
    ORDER BY er.start_time DESC
  </select>

  <insert id="insertWarning">
    INSERT INTO biz_exam_monitor_event 
    (exam_id, student_id, event_type, event_data, severity)
    VALUES 
    (#{examId}, #{studentId}, #{type}, #{message}, 'WARNING')
  </insert>

  <update id="forceSubmitExamRecord">
    UPDATE biz_exam_record
    SET status = 1, submit_time = NOW()
    WHERE exam_id = #{examId} AND student_id = #{studentId}
    AND status = 0
  </update>

</mapper>

