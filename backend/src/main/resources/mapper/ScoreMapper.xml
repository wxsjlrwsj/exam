<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.teacher.score.ScoreMapper">

  <resultMap id="RecordMap" type="org.example.chaoxingsystem.teacher.score.ExamRecord">
    <id property="id" column="id"/>
    <result property="examId" column="exam_id"/>
    <result property="studentId" column="student_id"/>
    <result property="score" column="score"/>
    <result property="status" column="status"/>
    <result property="startTime" column="start_time"/>
    <result property="submitTime" column="submit_time"/>
  </resultMap>

  <resultMap id="AnswerMap" type="org.example.chaoxingsystem.teacher.score.ExamAnswer">
    <id property="id" column="id"/>
    <result property="recordId" column="record_id"/>
    <result property="questionId" column="question_id"/>
    <result property="studentAnswer" column="student_answer"/>
    <result property="fileId" column="file_id"/>
    <result property="score" column="score"/>
    <result property="isCorrect" column="is_correct"/>
    <result property="comment" column="comment"/>
  </resultMap>

  <select id="count" resultType="long">
    SELECT COUNT(1)
    FROM biz_exam_record r
    LEFT JOIN users u ON u.id = r.student_id
    LEFT JOIN biz_student s ON s.user_id = u.id
    <where>
      <if test="examId != null">AND r.exam_id = #{examId}</if>
      <if test="classId != null">AND s.class_id = #{classId}</if>
      <if test="keyword != null and keyword != ''">AND (u.real_name LIKE CONCAT('%', #{keyword}, '%') OR u.username LIKE CONCAT('%', #{keyword}, '%'))</if>
    </where>
  </select>

  <select id="selectPage" resultType="java.util.Map">
    SELECT r.id, r.exam_id, r.student_id, u.real_name AS student_name, r.score, r.status, r.start_time, r.submit_time, s.class_id AS class_id
    FROM biz_exam_record r
    LEFT JOIN users u ON u.id = r.student_id
    LEFT JOIN biz_student s ON s.user_id = u.id
    <where>
      <if test="examId != null">AND r.exam_id = #{examId}</if>
      <if test="classId != null">AND s.class_id = #{classId}</if>
      <if test="keyword != null and keyword != ''">AND (u.real_name LIKE CONCAT('%', #{keyword}, '%') OR u.username LIKE CONCAT('%', #{keyword}, '%'))</if>
    </where>
    ORDER BY r.submit_time DESC, r.id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="selectRecord" resultMap="RecordMap">
    SELECT * FROM biz_exam_record WHERE exam_id = #{examId} AND student_id = #{studentId}
  </select>

  <select id="selectAnswersByRecordId" resultMap="AnswerMap">
    SELECT * FROM biz_exam_answer WHERE record_id = #{recordId}
  </select>

  <update id="updateRecordScore">
    UPDATE biz_exam_record SET score = #{score}, status = #{status} WHERE id = #{recordId}
  </update>

  <update id="updateAnswerScore">
    UPDATE biz_exam_answer SET score = #{score}, comment = #{comment} WHERE record_id = #{recordId} AND question_id = #{questionId}
  </update>

  <select id="selectStats" resultType="java.util.Map">
    SELECT
      COUNT(1) AS total,
      SUM(CASE WHEN r.status &gt;= 1 THEN 1 ELSE 0 END) AS submitted,
      SUM(CASE WHEN r.status = 2 THEN 1 ELSE 0 END) AS graded,
      AVG(r.score) AS avgScore,
      MAX(r.score) AS maxScore,
      MIN(r.score) AS minScore,
      SUM(CASE WHEN r.score IS NOT NULL AND r.score &gt;= p.pass_score THEN 1 ELSE 0 END) AS passCount
    FROM biz_exam_record r
    LEFT JOIN biz_exam e ON e.id = r.exam_id
    LEFT JOIN biz_paper p ON p.id = e.paper_id
    WHERE r.exam_id = #{examId}
  </select>

  <select id="selectRecordById" resultMap="RecordMap">
    SELECT * FROM biz_exam_record WHERE id = #{id}
  </select>

  <insert id="insertScoreAdjustment">
    INSERT INTO biz_score_adjustment (score_id, original_score, new_score, reason)
    VALUES (#{scoreId}, #{originalScore}, #{newScore}, #{reason})
  </insert>

  <update id="batchUpdateStatus">
    UPDATE biz_exam_record 
    SET status = #{status}
    WHERE id IN
    <foreach collection="scoreIds" item="sid" open="(" separator="," close=")">
      #{sid}
    </foreach>
  </update>

</mapper>
