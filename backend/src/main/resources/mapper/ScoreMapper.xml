<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.teacher.score.ScoreMapper">

  <resultMap id="RecordMap" type="org.example.chaoxingsystem.teacher.score.ExamRecord">
    <id property="id" column="id"/>
    <result property="examId" column="exam_id"/>
    <result property="studentId" column="student_id"/>
    <result property="score" column="score"/>
    <result property="status" column="status"/>
    <result property="startTime" column="start_time"/>
    <result property="submitTime" column="submit_time"/>
  </resultMap>

  <resultMap id="AnswerMap" type="org.example.chaoxingsystem.teacher.score.ExamAnswer">
    <id property="id" column="id"/>
    <result property="recordId" column="record_id"/>
    <result property="questionId" column="question_id"/>
    <result property="studentAnswer" column="student_answer"/>
    <result property="fileId" column="file_id"/>
    <result property="score" column="score"/>
    <result property="isCorrect" column="is_correct"/>
    <result property="comment" column="comment"/>
  </resultMap>

  <select id="selectRecord" resultMap="RecordMap">
    SELECT * FROM biz_exam_record
    WHERE exam_id = #{examId} AND student_id = #{studentId}
    LIMIT 1
  </select>

  <select id="selectAnswersByRecordId" resultMap="AnswerMap">
    SELECT * FROM biz_exam_answer
    WHERE record_id = #{recordId}
    ORDER BY id
  </select>

  <update id="updateRecordScore">
    UPDATE biz_exam_record
    SET score = #{score},
        status = COALESCE(#{status}, status)
    WHERE id = #{recordId}
  </update>

  <update id="updateAnswerScore">
    UPDATE biz_exam_answer
    SET score = #{score},
        comment = #{comment},
        is_correct = CASE WHEN #{score} IS NOT NULL AND #{score} > 0 THEN 1 ELSE is_correct END
    WHERE record_id = #{recordId} AND question_id = #{questionId}
  </update>

  <update id="updateScore">
    UPDATE biz_exam_record
    SET score = #{score}
    WHERE id = #{recordId}
  </update>

  <insert id="insertRecord" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO biz_exam_record (exam_id, student_id, score, status)
    VALUES (#{examId}, #{studentId}, #{score}, #{status})
  </insert>

  <update id="updateRecordStatus">
    UPDATE biz_exam_record
    SET status = #{status}
    WHERE id = #{recordId}
  </update>

</mapper>

