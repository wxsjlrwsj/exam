<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.common.SubjectMapper">

  <resultMap id="SubjectMap" type="org.example.chaoxingsystem.common.Subject">
    <id property="id" column="id"/>
    <result property="name" column="name"/>
    <result property="code" column="code"/>
    <result property="description" column="description"/>
    <result property="createTime" column="create_time"/>
  </resultMap>

  <select id="selectAll" resultMap="SubjectMap">
    SELECT * FROM biz_subject ORDER BY name
  </select>

  <select id="selectByTeacherId" resultMap="SubjectMap">
    SELECT s.* 
    FROM biz_subject s
    LEFT JOIN biz_teacher_subject ts ON s.id = ts.subject_id
    WHERE ts.teacher_id = #{teacherId} OR ts.teacher_id IS NULL
    ORDER BY s.name
  </select>

  <select id="selectById" resultMap="SubjectMap">
    SELECT * FROM biz_subject WHERE id = #{id}
  </select>

  <select id="selectByCode" resultMap="SubjectMap">
    SELECT * FROM biz_subject WHERE code = #{code}
  </select>

  <select id="countByNameAndCreatorId" resultType="int">
    SELECT COUNT(1)
    FROM biz_subject
    WHERE creator_user_id = #{creatorId}
      AND name COLLATE utf8mb4_unicode_ci = #{name} COLLATE utf8mb4_unicode_ci
  </select>

  <select id="countByNameAndTeacherId" resultType="int">
    SELECT COUNT(1)
    FROM biz_subject s
    JOIN biz_teacher_subject ts ON ts.subject_id = s.id
    WHERE ts.teacher_id = #{teacherId}
      AND s.name COLLATE utf8mb4_unicode_ci = #{name} COLLATE utf8mb4_unicode_ci
  </select>

  <insert id="insert" parameterType="org.example.chaoxingsystem.common.Subject" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO biz_subject (name, code, description)
    VALUES (#{name}, #{code}, #{description})
  </insert>

  <update id="updateById" parameterType="org.example.chaoxingsystem.common.Subject">
    UPDATE biz_subject SET
      name = #{name},
      code = #{code},
      description = #{description}
    WHERE id = #{id}
  </update>

  <delete id="deleteById">
    DELETE FROM biz_subject WHERE id = #{id}
  </delete>

</mapper>
