<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.teacher.audit.QuestionAuditMapper">

  <resultMap id="ListRowMap" type="org.example.chaoxingsystem.teacher.audit.QuestionAuditListRow">
    <id property="id" column="id"/>
    <result property="submitterId" column="submitter_id"/>
    <result property="submitterName" column="submitter_name"/>
    <result property="submitTime" column="submit_time"/>
    <result property="typeId" column="type_id"/>
    <result property="typeCode" column="type_code"/>
    <result property="difficulty" column="difficulty"/>
    <result property="subjectId" column="subject_id"/>
    <result property="status" column="status"/>
    <result property="content" column="content"/>
  </resultMap>

  <resultMap id="DetailMap" type="org.example.chaoxingsystem.teacher.audit.QuestionAuditDetail">
    <id property="id" column="id"/>
    <result property="submitterId" column="submitter_id"/>
    <result property="submitterName" column="submitter_name"/>
    <result property="submitTime" column="submit_time"/>
    <result property="typeId" column="type_id"/>
    <result property="typeCode" column="type_code"/>
    <result property="content" column="content"/>
    <result property="answer" column="answer"/>
    <result property="difficulty" column="difficulty"/>
    <result property="subjectId" column="subject_id"/>
    <result property="subjectName" column="subject_name"/>
    <result property="status" column="status"/>
    <result property="auditComment" column="audit_comment"/>
    <result property="auditorId" column="auditor_id"/>
    <result property="auditorName" column="auditor_name"/>
    <result property="auditTime" column="audit_time"/>
  </resultMap>

  <select id="count" resultType="long">
    SELECT COUNT(1)
    FROM biz_question_audit a
    LEFT JOIN users su ON su.id = a.submitter_id
    LEFT JOIN biz_student bs ON bs.user_id = su.id
    <where>
      <if test="status != null">AND a.status = #{status}</if>
      <if test="subjectId != null">AND a.subject_id = #{subjectId}</if>
      <if test="submitterName != null and submitterName != ''">AND COALESCE(bs.real_name, su.real_name) LIKE CONCAT('%', #{submitterName}, '%')</if>
      <if test="beginTime != null and beginTime != ''">AND a.submit_time &gt;= #{beginTime}</if>
      <if test="endTime != null and endTime != ''">AND a.submit_time &lt;= #{endTime}</if>
    </where>
  </select>

  <select id="selectPage" resultMap="ListRowMap">
    SELECT a.id, a.submitter_id, COALESCE(bs.real_name, su.real_name) AS submitter_name, a.submit_time, a.type_id, qt.type_code, a.difficulty, a.subject_id, a.status, a.content
    FROM biz_question_audit a
    LEFT JOIN users su ON su.id = a.submitter_id
    LEFT JOIN biz_student bs ON bs.user_id = su.id
    LEFT JOIN biz_question_type qt ON qt.type_id = a.type_id
    <where>
      <if test="status != null">AND a.status = #{status}</if>
      <if test="subjectId != null">AND a.subject_id = #{subjectId}</if>
      <if test="submitterName != null and submitterName != ''">AND COALESCE(bs.real_name, su.real_name) LIKE CONCAT('%', #{submitterName}, '%')</if>
      <if test="beginTime != null and beginTime != ''">AND a.submit_time &gt;= #{beginTime}</if>
      <if test="endTime != null and endTime != ''">AND a.submit_time &lt;= #{endTime}</if>
    </where>
    ORDER BY a.submit_time DESC, a.id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="selectDetail" resultMap="DetailMap">
    SELECT a.*, qt.type_code, COALESCE(bs.real_name, su.real_name) AS submitter_name, au.real_name AS auditor_name, s.name AS subject_name
    FROM biz_question_audit a
    LEFT JOIN biz_question_type qt ON qt.type_id = a.type_id
    LEFT JOIN users su ON su.id = a.submitter_id
    LEFT JOIN biz_student bs ON bs.user_id = su.id
    LEFT JOIN users au ON au.id = a.auditor_id
    LEFT JOIN biz_subject s ON s.id = a.subject_id
    WHERE a.id = #{id}
  </select>

  <select id="selectPendingDetailsForProcess" resultMap="DetailMap">
    SELECT a.*, qt.type_code, COALESCE(bs.real_name, su.real_name) AS submitter_name, s.name AS subject_name
    FROM biz_question_audit a
    LEFT JOIN biz_question_type qt ON qt.type_id = a.type_id
    LEFT JOIN users su ON su.id = a.submitter_id
    LEFT JOIN biz_student bs ON bs.user_id = su.id
    LEFT JOIN biz_subject s ON s.id = a.subject_id
    WHERE a.status = 0 AND a.id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
  </select>

  <update id="processBatch">
    UPDATE biz_question_audit
    SET status = #{status}, audit_comment = #{comment}, auditor_id = #{auditorId}, audit_time = CURRENT_TIMESTAMP
    WHERE status = 0 AND id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
  </update>

  <select id="selectForApproveInsert" resultType="org.example.chaoxingsystem.teacher.audit.QuestionAudit">
    SELECT id, submitter_id, type_id, content, answer, difficulty, subject_id
    FROM biz_question_audit
    WHERE status = 1
      AND question_id IS NULL
      AND id IN
      <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
  </select>

  <update id="updateQuestionId">
    UPDATE biz_question_audit
    SET question_id = #{questionId}
    WHERE id = #{id}
  </update>

  <insert id="insert" parameterType="org.example.chaoxingsystem.teacher.audit.QuestionAudit">
    INSERT INTO biz_question_audit(
      submitter_id, submit_time, type_id, content, answer, difficulty, subject_id, status
    ) VALUES (
      #{submitterId}, CURRENT_TIMESTAMP, #{typeId}, #{content}, #{answer}, #{difficulty}, #{subjectId}, 0
    )
  </insert>

</mapper>
