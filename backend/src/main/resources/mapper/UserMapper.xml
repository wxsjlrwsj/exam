<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.user.UserMapper">

  <select id="selectByUsername" parameterType="string" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, created_at
    FROM users
    WHERE username = #{username}
  </select>

  <select id="selectById" parameterType="long" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, created_at
    FROM users
    WHERE id = #{id}
  </select>

  <select id="selectByEmail" parameterType="string" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, created_at
    FROM users
    WHERE email = #{email}
  </select>

  <select id="countByUsername" parameterType="string" resultType="long">
    SELECT COUNT(*) FROM users WHERE username = #{username}
  </select>

  <select id="countByEmail" parameterType="string" resultType="long">
    SELECT COUNT(*) FROM users WHERE email = #{email}
  </select>

  <insert id="insert" parameterType="org.example.chaoxingsystem.user.User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO users (username, email, phone, password_hash, user_type, real_name, avatar)
    VALUES (#{username}, #{email}, #{phone}, #{passwordHash}, #{userType}, #{realName}, #{avatar})
  </insert>

  <update id="updatePasswordById" parameterType="map">
    UPDATE users SET password_hash = #{passwordHash}
    WHERE id = #{id}
  </update>

  <update id="updateProfileById" parameterType="map">
    UPDATE users SET
      email = #{email},
      phone = #{phone}
    WHERE id = #{id}
  </update>

  <select id="selectAll" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, created_at
    FROM users
    ORDER BY id
  </select>

  <select id="searchByUserType" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, created_at
    FROM users
    WHERE user_type = #{userType}
      <if test="keyword != null and keyword != ''">
        AND (username LIKE CONCAT('%', #{keyword}, '%') OR real_name LIKE CONCAT('%', #{keyword}, '%'))
      </if>
    ORDER BY id
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countByUserTypeAndKeyword" resultType="long">
    SELECT COUNT(*) FROM users
    WHERE user_type = #{userType}
      <if test="keyword != null and keyword != ''">
        AND (username LIKE CONCAT('%', #{keyword}, '%') OR real_name LIKE CONCAT('%', #{keyword}, '%'))
      </if>
  </select>

</mapper>
