<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.chaoxingsystem.user.UserMapper">

  <select id="selectByUsername" parameterType="string" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, qq_number, password_hash, user_type, real_name, avatar, bio, created_at
    FROM users
    WHERE username = #{username}
  </select>

  <select id="selectById" parameterType="long" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, qq_number, password_hash, user_type, real_name, avatar, bio, created_at
    FROM users
    WHERE id = #{id}
  </select>

  <select id="selectByEmail" parameterType="string" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, bio, created_at
    FROM users
    WHERE email = #{email}
  </select>

  <select id="countByUsername" parameterType="string" resultType="long">
    SELECT COUNT(*) FROM users WHERE username = #{username}
  </select>

  <select id="countByEmail" parameterType="string" resultType="long">
    SELECT COUNT(*) FROM users WHERE email = #{email}
  </select>

  <insert id="insert" parameterType="org.example.chaoxingsystem.user.User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO users (username, email, phone, qq_number, password_hash, user_type, real_name, avatar, bio)
    VALUES (#{username}, #{email}, #{phone}, #{qqNumber}, #{passwordHash}, #{userType}, #{realName}, #{avatar}, #{bio})
  </insert>

  <update id="updatePasswordById" parameterType="map">
    UPDATE users SET password_hash = #{passwordHash}
    WHERE id = #{id}
  </update>

  <update id="updateProfileById" parameterType="map">
    UPDATE users SET
      email = #{email},
      phone = #{phone},
      bio = #{bio}
    WHERE id = #{id}
  </update>

  <select id="selectAll" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, bio, created_at
    FROM users
    ORDER BY id
  </select>

  <select id="searchByUserType" resultType="org.example.chaoxingsystem.user.User">
    SELECT id, username, email, phone, password_hash, user_type, real_name, avatar, bio, created_at
    FROM users
    WHERE user_type = #{userType}
      <if test="keyword != null and keyword != ''">
        AND (username LIKE CONCAT('%', #{keyword}, '%') OR real_name LIKE CONCAT('%', #{keyword}, '%'))
      </if>
    ORDER BY id
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countByUserTypeAndKeyword" resultType="long">
    SELECT COUNT(*) FROM users
    WHERE user_type = #{userType}
      <if test="keyword != null and keyword != ''">
        AND (username LIKE CONCAT('%', #{keyword}, '%') OR real_name LIKE CONCAT('%', #{keyword}, '%'))
      </if>
  </select>

  <select id="searchCandidatesExcludingOrgMembers" resultType="org.example.chaoxingsystem.user.User">
    SELECT u.id, u.username, u.email, u.phone, u.password_hash, u.user_type, u.real_name, u.avatar, u.bio, u.created_at
    FROM users u
    WHERE u.user_type = #{userType}
      <if test="keyword != null and keyword != ''">
        AND (u.username LIKE CONCAT('%', #{keyword}, '%') OR u.real_name LIKE CONCAT('%', #{keyword}, '%'))
      </if>
      <choose>
        <when test="orgType == 'class' and userType == 'student'">
          AND NOT EXISTS (
            SELECT 1 FROM biz_student s 
            WHERE s.user_id = u.id AND s.class_id IS NOT NULL
          )
        </when>
        <when test="orgType == 'class' and userType == 'teacher'">
          AND NOT EXISTS (
            SELECT 1 
            FROM biz_teacher t 
            JOIN biz_class_teacher ct ON ct.teacher_id = t.id
            WHERE t.user_id = u.id AND ct.class_id = #{orgId}
          )
        </when>
        <when test="orgType == 'college' and userType == 'teacher'">
          AND NOT EXISTS (
            SELECT 1 FROM biz_teacher t 
            WHERE t.user_id = u.id AND t.college_id = #{orgId}
          )
        </when>
      </choose>
    ORDER BY u.id
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countCandidatesExcludingOrgMembers" resultType="long">
    SELECT COUNT(*) 
    FROM users u
    WHERE u.user_type = #{userType}
      <if test="keyword != null and keyword != ''">
        AND (u.username LIKE CONCAT('%', #{keyword}, '%') OR u.real_name LIKE CONCAT('%', #{keyword}, '%'))
      </if>
      <choose>
        <when test="orgType == 'class' and userType == 'student'">
          AND NOT EXISTS (
            SELECT 1 FROM biz_student s 
            WHERE s.user_id = u.id AND s.class_id IS NOT NULL
          )
        </when>
        <when test="orgType == 'class' and userType == 'teacher'">
          AND NOT EXISTS (
            SELECT 1 
            FROM biz_teacher t 
            JOIN biz_class_teacher ct ON ct.teacher_id = t.id
            WHERE t.user_id = u.id AND ct.class_id = #{orgId}
          )
        </when>
        <when test="orgType == 'college' and userType == 'teacher'">
          AND NOT EXISTS (
            SELECT 1 FROM biz_teacher t 
            WHERE t.user_id = u.id AND t.college_id = #{orgId}
          )
        </when>
      </choose>
  </select>

</mapper>
