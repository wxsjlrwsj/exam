import{r,a as J,W as Ue,q as Ie,c as M,d as u,b as l,w as t,e as s,i as Me,X as ze,o as p,n as _,j as d,f as N,Y as Ee,B as Oe,g as $e,Z as Be,t as q,_ as Q,S as Ae,$ as ee,p as Pe,a0 as Fe}from"./index-DOcvSAvK.js";import{s as y}from"./request-3uTHAmsp.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-ngrFHoWO.js";const Se={class:"org-container"},je={class:"card-header"},qe={class:"custom-tree-node"},Le={class:"node-label"},Ke={class:"node-actions"},We={class:"card-header"},Xe={key:0},Ye={key:0,class:"empty-tip"},Ze={key:1},Ge={class:"member-toolbar",style:{"margin-bottom":"15px","text-align":"right"}},He={style:{"margin-bottom":"10px",display:"flex",gap:"8px"}},Je={style:{"margin-top":"10px",display:"flex","justify-content":"space-between","align-items":"center"}},Qe={__name:"OrgManagement",setup(el){const b=Me("showMessage"),z=r(""),L=r(null),V=r(null),E=r(!1),w=r("detail"),k=r([]),O=r(!1),x=r(!1),$=r([]),B=r(!1),A=r(""),D=r(0),T=r(1),K=r(10),C=r(null),U=r([]),le={children:"children",label:"name"},m=J({isEdit:!1,isAdd:!1,parentData:null}),a=J({id:null,parentId:null,name:"",code:"",type:"department",sortOrder:1,leader:"",phone:"",status:"1",description:""}),te=r(""),ae={name:[{required:!0,message:"请输入机构名称",trigger:"blur"}],code:[{required:!0,message:"请输入机构编码",trigger:"blur"}],type:[{required:!0,message:"请选择机构类型",trigger:"change"}]},P=async()=>{try{const o=await y.get("/org/tree");U.value=o.data||[]}catch{U.value=[]}};Ue(z,o=>{L.value?.filter(o)});const oe=(o,e)=>o?e.name.includes(o):!0,ne=o=>!0,se=(o,e,c)=>!0,de=async(o,e,c,i)=>{try{await y.post("/org/move",{draggingNodeId:o.data.id,dropNodeId:e.data.id,dropType:c}),b("移动成功","success")}catch(f){console.error(f),b("移动失败，正在还原...","error"),P()}},F=()=>{a.id=null,a.parentId=null,a.name="",a.code="",a.type="department",a.sortOrder=1,a.leader="",a.phone="",a.status="1",a.description="",te.value=""},re=()=>{F(),m.isAdd=!0,m.isEdit=!1,m.parentData=null,a.parentId=null,a.type="school",k.value=[],w.value="detail"},ie=o=>{F(),m.isAdd=!0,m.isEdit=!1,m.parentData=o,a.parentId=o.id,o.type==="school"?a.type="college":o.type==="college"?a.type="department":(o.type,a.type="class"),k.value=[],w.value="detail"},W=async o=>{O.value=!0;try{const e=await y.get(`/org/${o}/members`);k.value=e.data||[]}catch(e){console.error(e),k.value=[]}finally{O.value=!1}},ue=()=>{x.value=!0,T.value=1,C.value=null,R()},R=async()=>{if(a.id){B.value=!0;try{const o=await y.get(`/org/${a.id}/members/candidates`,{params:{keyword:A.value,pageNum:T.value,pageSize:K.value}});$.value=o.data?.list||[],D.value=o.data?.total||0}catch{$.value=[],D.value=0}finally{B.value=!1}}},pe=o=>{C.value=o||null},me=o=>{T.value=o,R()},ce=async()=>{if(!(!a.id||!C.value))try{await y.post(`/org/${a.id}/members/assign`,{userId:C.value.id}),x.value=!1,W(a.id),b("添加成功","success")}catch{b("添加失败","error")}},fe=o=>{m.isEdit=!0,m.isAdd=!1,m.parentData=null,w.value="detail",Object.assign(a,{...o,status:o.status||"1"}),W(o.id)},ge=(o,e)=>{Fe.confirm(`确定要删除机构 "${e.name}" 吗? 此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await y.delete(`/org/${e.id}`);const c=o.parent,i=c.data.children||c.data,f=i.findIndex(S=>S.id===e.id);i.splice(f,1),F(),m.isEdit=!1,b("删除成功","success")}catch{}})},_e=async()=>{V.value&&await V.value.validate(async o=>{if(o){E.value=!0;try{await y.post("/org/save",a),P(),b("保存成功","success")}catch{}finally{E.value=!1}}})},ve=()=>{V.value&&V.value.resetFields()};return Ie(()=>{P()}),(o,e)=>{const c=s("el-icon"),i=s("el-button"),f=s("el-input"),S=s("el-tree"),X=s("el-card"),Y=s("el-col"),ye=s("el-empty"),be=s("el-tree-select"),g=s("el-form-item"),I=s("el-radio"),Ve=s("el-radio-group"),we=s("el-input-number"),ke=s("el-switch"),xe=s("el-form"),Z=s("el-tab-pane"),v=s("el-table-column"),j=s("el-tag"),G=s("el-table"),Ce=s("el-tabs"),he=s("el-row"),Ne=s("el-pagination"),De=s("el-dialog"),H=ze("loading");return p(),M("div",Se,[e[33]||(e[33]=u("div",{class:"page-header"},[u("h2",{class:"page-title"},"组织机构管理")],-1)),l(he,{gutter:20,class:"main-content"},{default:t(()=>[l(Y,{span:8},{default:t(()=>[l(X,{class:"tree-card"},{header:t(()=>[u("div",je,[e[15]||(e[15]=u("span",null,"组织架构图",-1)),l(i,{type:"primary",size:"small",onClick:re},{default:t(()=>[l(c,null,{default:t(()=>[l(N(Ae))]),_:1}),e[14]||(e[14]=d(" 新增根机构 ",-1))]),_:1})])]),default:t(()=>[l(f,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=n=>z.value=n),placeholder:"输入关键字过滤","prefix-icon":"Search",clearable:"",style:{"margin-bottom":"15px"}},null,8,["modelValue"]),l(S,{ref_key:"treeRef",ref:L,data:U.value,props:le,"node-key":"id","default-expand-all":"","filter-node-method":oe,"expand-on-click-node":!1,"highlight-current":"",draggable:"","allow-drop":se,"allow-drag":ne,onNodeClick:fe,onNodeDrop:de},{default:t(({node:n,data:h})=>[u("span",qe,[u("span",Le,[h.type==="school"?(p(),_(c,{key:0},{default:t(()=>[l(N(Ee))]),_:1})):h.type==="college"?(p(),_(c,{key:1},{default:t(()=>[l(N(Oe))]),_:1})):h.type==="class"?(p(),_(c,{key:2},{default:t(()=>[l(N($e))]),_:1})):(p(),_(c,{key:3},{default:t(()=>[l(N(Be))]),_:1})),d(" "+q(n.label),1)]),u("span",Ke,[l(i,{link:"",type:"primary",size:"small",onClick:Q(Te=>ie(h),["stop"])},{default:t(()=>[...e[16]||(e[16]=[d(" 新增下级 ",-1)])]),_:1},8,["onClick"]),l(i,{link:"",type:"danger",size:"small",onClick:Q(Te=>ge(n,h),["stop"])},{default:t(()=>[...e[17]||(e[17]=[d(" 删除 ",-1)])]),_:1},8,["onClick"])])])]),_:1},8,["data"])]),_:1})]),_:1}),l(Y,{span:16},{default:t(()=>[l(X,{class:"detail-card"},{header:t(()=>[u("div",We,[u("span",null,q(a.id?"编辑机构":"新增机构"),1),a.id||a.parentId?(p(),M("div",Xe,[l(i,{type:"primary",loading:E.value,onClick:_e},{default:t(()=>[...e[18]||(e[18]=[d("保存",-1)])]),_:1},8,["loading"]),l(i,{onClick:ve},{default:t(()=>[...e[19]||(e[19]=[d("重置",-1)])]),_:1})])):Pe("",!0)])]),default:t(()=>[!m.isEdit&&!m.isAdd?(p(),M("div",Ye,[l(ye,{description:"请选择左侧机构或点击新增"})])):(p(),M("div",Ze,[l(Ce,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=n=>w.value=n)},{default:t(()=>[l(Z,{label:"机构详情",name:"detail"},{default:t(()=>[l(xe,{ref_key:"formRef",ref:V,model:a,rules:ae,"label-width":"100px",class:"org-form",style:{"margin-top":"20px"}},{default:t(()=>[l(g,{label:"上级机构"},{default:t(()=>[l(be,{modelValue:a.parentId,"onUpdate:modelValue":e[1]||(e[1]=n=>a.parentId=n),data:U.value,props:{label:"name",value:"id",children:"children"},"check-strictly":"",placeholder:"请选择上级机构 (可留空作为根节点)",style:{width:"100%"}},null,8,["modelValue","data"])]),_:1}),l(g,{label:"机构名称",prop:"name"},{default:t(()=>[l(f,{modelValue:a.name,"onUpdate:modelValue":e[2]||(e[2]=n=>a.name=n),placeholder:"请输入机构名称"},null,8,["modelValue"])]),_:1}),l(g,{label:"机构编码",prop:"code"},{default:t(()=>[l(f,{modelValue:a.code,"onUpdate:modelValue":e[3]||(e[3]=n=>a.code=n),placeholder:"唯一编码，如: DEV_DEPT"},null,8,["modelValue"])]),_:1}),l(g,{label:"机构类型",prop:"type"},{default:t(()=>[l(Ve,{modelValue:a.type,"onUpdate:modelValue":e[4]||(e[4]=n=>a.type=n)},{default:t(()=>[l(I,{label:"school"},{default:t(()=>[...e[20]||(e[20]=[d("学校",-1)])]),_:1}),l(I,{label:"college"},{default:t(()=>[...e[21]||(e[21]=[d("学院",-1)])]),_:1}),l(I,{label:"department"},{default:t(()=>[...e[22]||(e[22]=[d("部门/系",-1)])]),_:1}),l(I,{label:"class"},{default:t(()=>[...e[23]||(e[23]=[d("班级",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(g,{label:"显示排序",prop:"sortOrder"},{default:t(()=>[l(we,{modelValue:a.sortOrder,"onUpdate:modelValue":e[5]||(e[5]=n=>a.sortOrder=n),min:0,max:999},null,8,["modelValue"])]),_:1}),l(g,{label:"负责人",prop:"leader"},{default:t(()=>[l(f,{modelValue:a.leader,"onUpdate:modelValue":e[6]||(e[6]=n=>a.leader=n),placeholder:"部门负责人姓名"},null,8,["modelValue"])]),_:1}),l(g,{label:"联系电话",prop:"phone"},{default:t(()=>[l(f,{modelValue:a.phone,"onUpdate:modelValue":e[7]||(e[7]=n=>a.phone=n),placeholder:"联系电话"},null,8,["modelValue"])]),_:1}),l(g,{label:"状态",prop:"status"},{default:t(()=>[l(ke,{modelValue:a.status,"onUpdate:modelValue":e[8]||(e[8]=n=>a.status=n),"active-value":"1","inactive-value":"0","active-text":"启用","inactive-text":"停用"},null,8,["modelValue"])]),_:1}),l(g,{label:"备注"},{default:t(()=>[l(f,{modelValue:a.description,"onUpdate:modelValue":e[9]||(e[9]=n=>a.description=n),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),l(Z,{label:"成员管理",name:"members"},{default:t(()=>[u("div",Ge,[l(i,{type:"primary",size:"small",icon:"Plus",onClick:ue},{default:t(()=>[...e[24]||(e[24]=[d("添加成员",-1)])]),_:1})]),ee((p(),_(G,{data:k.value,border:"",stripe:"",style:{width:"100%"}},{default:t(()=>[l(v,{prop:"username",label:"用户名",width:"120"}),l(v,{prop:"realName",label:"姓名",width:"120"}),l(v,{prop:"userType",label:"角色",width:"100"},{default:t(({row:n})=>[n.userType==="student"?(p(),_(j,{key:0,type:"success"},{default:t(()=>[...e[25]||(e[25]=[d("学生",-1)])]),_:1})):n.userType==="teacher"?(p(),_(j,{key:1,type:"warning"},{default:t(()=>[...e[26]||(e[26]=[d("教师",-1)])]),_:1})):(p(),_(j,{key:2},{default:t(()=>[...e[27]||(e[27]=[d("管理员",-1)])]),_:1}))]),_:1}),l(v,{prop:"studentNo",label:"学号/工号",width:"120"}),l(v,{label:"操作",width:"150",fixed:"right"},{default:t(()=>[l(i,{link:"",type:"primary",size:"small"},{default:t(()=>[...e[28]||(e[28]=[d("编辑",-1)])]),_:1}),l(i,{link:"",type:"danger",size:"small"},{default:t(()=>[...e[29]||(e[29]=[d("移除",-1)])]),_:1})]),_:1})]),_:1},8,["data"])),[[H,O.value]])]),_:1})]),_:1},8,["modelValue"])]))]),_:1})]),_:1})]),_:1}),l(De,{modelValue:x.value,"onUpdate:modelValue":e[13]||(e[13]=n=>x.value=n),title:"添加成员",width:"700px"},{footer:t(()=>[l(i,{onClick:e[12]||(e[12]=n=>x.value=!1)},{default:t(()=>[...e[31]||(e[31]=[d("取消",-1)])]),_:1}),l(i,{type:"primary",disabled:!C.value,onClick:ce},{default:t(()=>[...e[32]||(e[32]=[d("确认添加",-1)])]),_:1},8,["disabled"])]),default:t(()=>[u("div",He,[l(f,{modelValue:A.value,"onUpdate:modelValue":e[11]||(e[11]=n=>A.value=n),placeholder:"输入姓名或用户名",clearable:""},null,8,["modelValue"]),l(i,{type:"primary",onClick:R},{default:t(()=>[...e[30]||(e[30]=[d("搜索",-1)])]),_:1})]),ee((p(),_(G,{data:$.value,"highlight-current-row":"",onCurrentChange:pe,style:{width:"100%"}},{default:t(()=>[l(v,{prop:"username",label:"用户名",width:"140"}),l(v,{prop:"realName",label:"姓名",width:"160"}),l(v,{prop:"userType",label:"类型",width:"120"})]),_:1},8,["data"])),[[H,B.value]]),u("div",Je,[u("div",null,"共 "+q(D.value)+" 条",1),l(Ne,{small:"",layout:"prev, pager, next",total:D.value,"page-size":K.value,"current-page":T.value,onCurrentChange:me},null,8,["total","page-size","current-page"])])]),_:1},8,["modelValue"])])}}},nl=Re(Qe,[["__scopeId","data-v-3b8cbce1"]]);export{nl as default};
